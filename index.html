<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>하계수련원 식권 구매 선결제 주문서</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better scrolling */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            margin-top: 20px; /* Add some top margin */
        }
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #3b82f6; /* Blue focus border */
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937; /* Dark gray text */
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb; /* Light border for separation */
            padding-bottom: 10px;
        }
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #e5e7eb; /* Dashed border for menu items */
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        .quantity-input {
            width: 80px;
            text-align: center;
            margin-left: 10px;
        }
        .total-amount-box {
            background-color: #eff6ff; /* Light blue background */
            border: 1px solid #bfdbfe; /* Blue border */
            padding: 16px;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af; /* Darker blue text */
            text-align: center;
            margin-top: 24px;
        }
        .submit-button {
            background-color: #22c55e; /* Green button */
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
            border: none;
        }
        .submit-button:hover {
            background-color: #16a34a; /* Darker green on hover */
            transform: translateY(-2px);
        }
        .submit-button:active {
            transform: translateY(0);
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .bank-info {
            background-color: #f0f9ff; /* Very light blue */
            border: 1px solid #bfdbfe;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
        }
        .bank-info p {
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: #333;
        }
        .bank-info strong {
            color: #1e40af;
        }
        /* Loading spinner styles */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">하계수련원 식권 구매 선결제 주문서</h1>

        <!-- HTML form with action and method attributes -->
        <!-- target="hidden_iframe" 및 <iframe> 태그 제거 -->
        <form id="orderForm" action="https://script.google.com/macros/s/AKfycbwV2iNPVA6ITfXrR1tzjPf09t3l-YiAqWNyRawiOiRiqO53bOlEZDwikY9D73jcxBGz/exec" method="POST">
            <!-- 고객 정보 섹션 -->
            <div class="mb-8">
                <h2 class="section-title">1. 고객 정보</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customerName" class="block text-gray-700 text-sm font-medium mb-2">이름 / 단체명</label>
                        <input type="text" id="customerName" name="customerName" placeholder="홍길동 또는 행복 모임" required>
                    </div>
                    <div>
                        <label for="customerTel" class="block text-gray-700 text-sm font-medium mb-2">연락처</label>
                        <input type="tel" id="customerTel" name="customerTel" placeholder="010-1234-5678" required>
                    </div>
                    <div>
                        <label for="customerDepartment" class="block text-gray-700 text-sm font-medium mb-2">소속 부서</label>
                        <input type="text" id="customerDepartment" name="customerDepartment" placeholder="세종청 세종경찰서">
                    </div>
                </div>
            </div>

            <!-- 식사 정보 섹션 -->
            <div class="mb-8">
                <h2 class="section-title">2. 식사 정보</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="checkInDate" class="block text-gray-700 text-sm font-medium mb-2">입실일 (Check-in date)</label>
                        <input type="date" id="checkInDate" name="checkInDate" required>
                    </div>
                    <div>
                        <label for="checkOutDate" class="block text-gray-700 text-sm font-medium mb-2">퇴실일 (Check-out date)</label>
                        <input type="date" id="checkOutDate" name="checkOutDate" required>
                    </div>
                    <div>
                        <label for="adultPeople" class="block text-gray-700 text-sm font-medium mb-2">성인 인원</label>
                        <input type="number" id="adultPeople" name="adultPeople" min="0" value="0" required>
                    </div>
                    <div>
                        <label for="childPeople" class="block text-gray-700 text-sm font-medium mb-2">36개월 미만 인원</label>
                        <input type="number" id="childPeople" name="childPeople" min="0" value="0" required>
                    </div>
                </div>
            </div>

            <!-- 식권 선택 섹션 -->
            <div class="mb-8">
                <h2 class="section-title">3. 식권 선택</h2>
                <p class="text-sm text-gray-600 mb-4">
                    수련원 이용인원 중 아침, 점심, 저녁 식권을 각각 몇 장 구매할지 총 수량을 입력해주세요.
                    (예: 성인 3명 중 아침 식사를 2명만 한다면 '아침' 수량에 '2'를 입력)
                </p>
                <div id="menuList" class="space-y-2">
                    <!-- Menu items will be dynamically loaded here by JavaScript -->
                </div>
            </div>

            <!-- 총 결제 금액 섹션 -->
            <div class="mb-8">
                <h2 class="section-title">4. 총 결제 예정 금액</h2>
                <div class="total-amount-box">
                    총 금액: <span id="totalAmountDisplay">0</span>원
                    <!-- Hidden input to send total amount to Google Sheet -->
                    <input type="hidden" id="totalAmount" name="totalAmount" value="0">
                </div>
                <p class="text-sm text-gray-600 mt-4 text-center">선택하신 식권과 수량에 따라 금액이 자동 계산됩니다.</p>
            </div>

            <!-- 이용 약관 및 환불 규정 섹션 -->
            <div class="mb-8">
                <h2 class="section-title">5. 이용 약관 및 환불 규정</h2>
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 text-sm text-gray-700 leading-relaxed">
                    <p class="mb-2">본 주문서는 하계 수련원의 식당을 이용하는 식권을 구매하는 설문입니다. 정확한 정보 기입 및 입금 부탁드립니다.</p>
                    <p class="mb-2"><strong>환불 규정:</strong></p>
                    <ul class="list-disc list-inside ml-4">
                        <li>환불 불가 (음식을 미리 준비하는 관계로 환불은 불가능 합니다.)</li>
                    </ul>
                    <p class="mt-4 font-semibold">위 이용 약관 및 환불 규정을 확인하였으며 동의합니다.</p>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="agreeTerms" name="agreeTerms" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" required>
                        <label for="agreeTerms" class="ml-2 text-gray-700">동의합니다.</label>
                    </div>
                </div>
            </div>

            <!-- 주문서 제출 버튼 -->
            <button type="submit" class="submit-button">주문서 제출 및 결제 안내</button>
        </form>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- 모달 (결제 안내) -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">주문서 제출 완료!</h3>
            <p class="text-gray-700 mb-6">예약이 성공적으로 접수되었습니다. 아래 계좌 정보로 선결제 금액을 입금해주시면 예약이 최종 확정됩니다.</p>
            <div class="bank-info">
                <p><strong>총 결제 금액:</strong> <span id="modalTotalAmount" class="text-green-600">0</span>원</p>
                <p><strong>은행명:</strong> <span id="bankName">농협</span></p>
                <p><strong>계좌번호:</strong> <span id="accountNumber">301-0341-4188-81</span></p>
                <p><strong>예금주:</strong> <span id="accountHolder">푸디스트</span></p>
                <p class="text-sm text-gray-500 mt-2">주문자와 동일하게 입금해주시면 확인이 빠릅니다.</p>
            </div>
            <p class="text-gray-700 mt-6">문의사항은 식당으로 연락주세요. 감사합니다!</p>
        </div>
    </div>

    <script>
        // 메뉴 데이터 (이름, 가격)
        const menuItems = [
            { name: "아침", price: 6000 },
            { name: "점심", price: 6000 },
            { name: "저녁", price: 6000 },
            { name: "36개월 미만", price: 0 } // 36개월 미만 식권 추가
        ];

        // 페이지 로드 시 메뉴 목록 동적 생성
        document.addEventListener('DOMContentLoaded', () => {
            const menuListDiv = document.getElementById('menuList');
            if (menuListDiv) { // null 체크 추가
                menuListDiv.innerHTML = ''; // 기존 메뉴를 지우고 새로 생성
                menuItems.forEach((item, index) => {
                    const menuItemHtml = `
                        <div class="menu-item">
                            <label for="menu-${index}" class="text-gray-800 text-base font-medium">${item.name} (${item.price.toLocaleString()}원)</label>
                            <input type="number" id="menu-${index}" name="menu-${index}" class="quantity-input" min="0" value="0" data-price="${item.price}" onchange="calculateTotal()">
                        </div>
                    `;
                    menuListDiv.innerHTML += menuItemHtml;
                });
            }
            calculateTotal(); // 초기 총 금액 계산

            // 폼 제출 이벤트 리스너 추가
            const orderForm = document.getElementById('orderForm');
            if (orderForm) { // null 체크 추가
                orderForm.addEventListener('submit', submitOrder);
            }
        });

        // 총 금액 계산 함수
        function calculateTotal() {
            let total = 0;
            menuItems.forEach((item, index) => {
                const quantityInput = document.getElementById(`menu-${index}`);
                if (quantityInput) { // 요소가 존재하는지 확인
                    const quantity = parseInt(quantityInput.value);
                    if (!isNaN(quantity) && quantity > 0) {
                        total += quantity * item.price;
                    }
                }
            });
            const totalAmountDisplay = document.getElementById('totalAmountDisplay');
            const totalAmountInput = document.getElementById('totalAmount');

            if (totalAmountDisplay) { // null 체크 추가
                totalAmountDisplay.innerText = total.toLocaleString();
            }
            if (totalAmountInput) { // null 체크 추가
                totalAmountInput.value = total; // Hidden input에 값 업데이트
            }
        }

        // 주문서 제출 함수 (fetch API 사용)
        async function submitOrder(event) {
            event.preventDefault(); // 기본 폼 제출 동작 방지

            // 필수 입력 필드 유효성 검사
            const customerName = document.getElementById('customerName');
            const customerTel = document.getElementById('customerTel');
            const customerDepartment = document.getElementById('customerDepartment');
            const checkInDate = document.getElementById('checkInDate');
            const checkOutDate = document.getElementById('checkOutDate');
            const adultPeople = document.getElementById('adultPeople');
            const childPeople = document.getElementById('childPeople');
            const agreeTerms = document.getElementById('agreeTerms');

            // 모든 요소가 존재하는지 먼저 확인
            if (!customerName || !customerTel || !customerDepartment || !checkInDate || !checkOutDate || !adultPeople || !childPeople || !agreeTerms) {
                alert('폼을 처리하는 데 필요한 일부 요소가 누락되었습니다. 페이지를 새로고침하거나 개발자에게 문의하세요.');
                console.error('Missing required form elements for validation.');
                return;
            }

            if (!customerName.value || !customerTel.value || !customerDepartment.value || !checkInDate.value || !checkOutDate.value || isNaN(parseInt(adultPeople.value)) || isNaN(parseInt(childPeople.value)) || !agreeTerms.checked) {
                alert('모든 필수 정보를 입력하고 이용 약관에 동의해주세요.');
                return;
            }

            const adultCount = parseInt(adultPeople.value);
            const childCount = parseInt(childPeople.value);

            if (adultCount === 0 && childCount === 0) {
                alert('수련원 이용인원을 1명 이상 입력해주세요 (성인 또는 36개월 미만).');
                return;
            }

            const inDate = new Date(checkInDate.value);
            const outDate = new Date(checkOutDate.value);
            if (outDate < inDate) {
                alert('퇴실일은 입실일보다 빠를 수 없습니다.');
                return;
            }

            let hasSelectedMenu = false;
            menuItems.forEach((item, index) => {
                const quantityInput = document.getElementById(`menu-${index}`);
                if (quantityInput && parseInt(quantityInput.value) > 0) {
                    hasSelectedMenu = true;
                }
            });

            if (!hasSelectedMenu) {
                alert('최소 한 개 이상의 식권을 선택해주세요.');
                return;
            }

            // 로딩 오버레이 표시
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }

            const form = event.target;
            const formData = new FormData(form);
            const url = form.action; // 폼의 action 속성에서 Apps Script URL 가져오기

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const resultText = await response.text();
                    if (resultText === "Success") {
                        const totalAmountInput = document.getElementById('totalAmount');
                        const modalTotalAmount = document.getElementById('modalTotalAmount');
                        const paymentModal = document.getElementById('paymentModal');

                        if (totalAmountInput && modalTotalAmount && paymentModal) {
                            const totalAmount = totalAmountInput.value;
                            modalTotalAmount.innerText = parseInt(totalAmount).toLocaleString();
                            paymentModal.style.display = 'flex'; // 모달 표시
                            form.reset(); // 폼 초기화 (선택 사항)
                            calculateTotal(); // 폼 초기화 후 총 금액도 0으로 업데이트
                        } else {
                            console.error("필수 DOM 요소가 없습니다: totalAmountInput, modalTotalAmount, paymentModal");
                            alert('주문서 제출에 실패했습니다. (UI 요소 누락)');
                        }
                    } else {
                        alert('주문서 제출에 실패했습니다. 다시 시도해주세요. (Apps Script 응답 오류)');
                        console.error('Apps Script 응답 오류:', resultText);
                    }
                } else {
                    alert('주문서 제출에 실패했습니다. 서버 응답 오류: ' + response.status);
                    console.error('Fetch 오류:', response.status, response.statusText);
                }
            } catch (error) {
                alert('주문서 제출 중 오류가 발생했습니다. 네트워크 연결을 확인해주세요.');
                console.error('Fetch 에러:', error);
            } finally {
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        }

        // 모달 닫기 함수
        function closeModal() {
            const paymentModal = document.getElementById('paymentModal');
            if (paymentModal) {
                paymentModal.style.display = 'none';
            }
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (modal && event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
